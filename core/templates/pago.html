{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pago - YSJI FASHION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; }
        .card-payment {
            max-width: 430px;
            margin: 50px auto 0 auto;
            border-radius: 20px;
            box-shadow: 0 6px 32px rgba(0,0,0,0.11);
            border: none;
        }
        .credit-card-visual {
            background: linear-gradient(120deg, #0d6efd 60%, #55a7f3 100%);
            border-radius: 16px;
            color: #fff;
            padding: 20px 24px 18px 24px;
            margin-bottom: 22px;
            position: relative;
            box-shadow: 0 2px 16px rgba(13,110,253,0.13);
        }
        .credit-card-visual .cc-chip { width: 38px; height: 26px; background: #fff; border-radius: 7px; margin-bottom: 18px; }
        .credit-card-visual .cc-number { font-size: 1.15rem; letter-spacing: 2.5px; margin-bottom: 10px; }
        .credit-card-visual .cc-label { font-size: .75rem; opacity: .85; }
        .credit-card-visual .cc-footer { display:flex; justify-content:space-between; align-items:flex-end; margin-top:12px; }
        .resumen-titulo { text-align:left; font-size:1.01rem; font-weight:600; color:#0d6efd; margin-bottom:2px; margin-top:10px; }
        .list-group-item img { border-radius:7px; }
        .btn-primary { background: linear-gradient(90deg, #3079ed 60%, #56aaff 100%); border:none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card card-payment p-4">
            <div class="credit-card-visual mb-3">
                <div class="cc-chip"></div>
                <div class="cc-number" id="ccNumberVisual">•••• •••• •••• ••••</div>
                <div class="cc-footer">
                    <div>
                        <div class="cc-label">Nombre</div>
                        <div id="ccNameVisual" style="font-size:1.01rem;font-weight:500;">TITULAR</div>
                    </div>
                    <div class="cc-brand"><i class="bi bi-credit-card"></i></div>
                </div>
            </div>

            <!-- Resumen de compra -->
            <div id="resumen-compra"></div>

            <!-- Contenedor del botón PayPal -->
            <div id="paypal-button-container" class="mt-2"></div>

            <div class="text-center mt-3">
                <a href="{% url 'Catalogo' %}" class="text-decoration-none text-secondary"><i class="bi bi-arrow-left"></i> Volver al catálogo</a>
            </div>
        </div>
    </div>

    <script>
    // Utilidades
    function getQueryParam(param) { return new URLSearchParams(window.location.search).has(param); }

    function getStoredProducts() {
        try { return JSON.parse(localStorage.getItem(getQueryParam('buynow') ? 'buyNowProduct' : 'cart') || '[]'); }
        catch(e){ return []; }
    }

    function clearStorageAfterPurchase() {
        if (getQueryParam('buynow')) localStorage.removeItem('buyNowProduct');
        else localStorage.removeItem('cart');
    }

    function computeTotalCOP(products) {
        let total = 0;
        products.forEach(p => total += Number(p.precio || 0) * (p.cantidad || 1));
        return total;
    }

    // Tasa ejemplo (mejor calcular en backend)
    const EXCHANGE_RATE_COP_TO_USD = 4000;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Render resumen
    document.addEventListener('DOMContentLoaded', function(){
        const resumenDiv = document.getElementById('resumen-compra');
        const productos = getStoredProducts();
        if (!productos || productos.length === 0) {
            resumenDiv.innerHTML = '<div class="resumen-titulo text-muted">No hay productos en la compra</div>';
            return;
        }
        let html = `<div class="resumen-titulo">Resumen de compra</div><ul class="list-group mb-2">`;
        let totalCOP = 0;
        productos.forEach(p=>{
            html += `<li class="list-group-item d-flex align-items-center border-0" style="background:#f9fcff;">
                        ${p.imagen ? `<img src="${p.imagen}" style="width:45px;height:45px;object-fit:cover;margin-right:14px;">` : ''}
                        <span class="flex-grow-1" style="font-size:1.01rem">${p.nombre} ${p.cantidad ? 'x'+p.cantidad : ''}</span>
                        <span class="fw-bold text-primary" style="font-size:.98rem">$${Number(p.precio).toLocaleString()} COP</span>
                     </li>`;
            totalCOP += Number(p.precio) * (p.cantidad || 1);
        });
        html += `</ul><div class="text-end fw-bold text-success fs-5 mb-2">Total: $${totalCOP.toLocaleString()} COP</div>`;
        resumenDiv.innerHTML = html;
    });

    const FACTURA_URL_TEMPLATE = "{% url 'factura_pedido' 0 %}";

    </script>

    <!-- PayPal SDK (sandbox client-id) -->
    <script src="https://www.paypal.com/sdk/js?client-id=AfFmoNGhHVg4hXOHy6wtl10KQZNu9qmKPy5oNMw3EFtvJfQtvb_JdyZyv2W2fB30HMqDv1qym_FBIZ6v&currency=USD"></script>

    <script>
    (function waitForPaypal(){
        if (!window.paypal) { return setTimeout(waitForPaypal, 200); }

        // Preparar datos
        const productos = getStoredProducts();
        const totalCOP = computeTotalCOP(productos);
        if (totalCOP <= 0) return;

        const totalUSD = (totalCOP / EXCHANGE_RATE_COP_TO_USD).toFixed(2);

        paypal.Buttons({
            // Validación previa
            onClick: function(data, actions) {
                console.log('[PayPal] onClick', data);
                if (!productos || productos.length === 0) {
                    Swal.fire('Error','No hay productos para pagar.','error');
                    return actions.reject();
                }
                return actions.resolve();
            },

            createOrder: function(data, actions) {
                console.log('[PayPal] createOrder totalUSD=', totalUSD);
                return actions.order.create({
                    purchase_units: [{
                        amount: { currency_code: 'USD', value: String(totalUSD) },
                        description: 'Compra YSJI FASHION'
                    }]
                }).then(function(orderID){
                    console.log('[PayPal] order created id=', orderID);
                    return orderID;
                }).catch(function(err){
                    console.error('[PayPal] createOrder error', err);
                    Swal.fire('Error','No se pudo crear la orden en PayPal. Revisa consola.','error');
                    throw err;
                });
            },

            onApprove: function(data, actions) {
                console.log('[PayPal] onApprove data=', data);
                return actions.order.capture().then(function(details){
                    console.log('[PayPal] capture details=', details);

                    // Enviar al backend para verificar y guardar pedido
                    fetch("{% url 'paypal_confirm' %}", {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            carrito: productos,
                            payer: details.payer || null
                        })
                    }).then(async (resp) => {
                    const json = await resp.json().catch(()=>null);
                    console.log('paypal_confirm resp status=', resp.status, 'body=', json);
                    // Busca esta sección y reemplázala:
                    if (resp.ok && json && json.ok) {
                        // Construir URL de factura
                        let facturaUrl = null;
                        if (json.pedido_id) {
                            facturaUrl = FACTURA_URL_TEMPLATE.replace('0', String(json.pedido_id));
                        }

                        clearStorageAfterPurchase();
                        Swal.fire({ 
                            title: false,
                            html: `
                                <div class="text-start p-4" style="font-family: 'Segoe UI', Arial, sans-serif;">
                                    <!-- Encabezado -->
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <div>
                                            <h3 style="color: #2C3E50; margin: 0;">YSJI FASHION</h3>
                                            <small class="text-muted">NIT: 900.XXX.XXX-X</small>
                                        </div>
                                        <div class="text-end">
                                            <h4 style="color: #2C3E50; margin: 0;">FACTURA</h4>
                                            <small class="text-muted">#${data.orderID.slice(-8)}</small>
                                        </div>
                                    </div>

                                    <!-- Información -->
                                    <div style="background: #F8F9FA; padding: 15px; border-radius: 8px;" class="mb-4">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted d-block">Fecha de Emisión</small>
                                                <strong>${new Date().toLocaleDateString('es-CO', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric'
                                                })}</strong>
                                            </div>
                                            <div class="col-6 text-end">
                                                <small class="text-muted d-block">Método de Pago</small>
                                                <strong>PayPal</strong>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Productos -->
                                    <div class="mb-4">
                                        <h6 style="color: #2C3E50; font-weight: 600;" class="mb-3">DETALLE DE PRODUCTOS</h6>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            ${productos.map(p => `
                                                <div class="d-flex justify-content-between align-items-center py-2" 
                                                    style="border-bottom: 1px solid #eee;">
                                                    <div>
                                                        <span style="color: #2C3E50;">${p.nombre}</span>
                                                        <small class="text-muted d-block">Cantidad: ${p.cantidad || 1}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span style="color: #2C3E50;">$${Number(p.precio).toLocaleString()} COP</span>
                                                        <small class="text-muted d-block">
                                                            Subtotal: $${(Number(p.precio) * (p.cantidad || 1)).toLocaleString()} COP
                                                        </small>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <!-- Total -->
                                    <div style="background: #2C3E50; color: white; padding: 15px; border-radius: 8px;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span>Total</span>
                                                <small class="d-block">IVA incluido</small>
                                            </div>
                                            <div class="text-end">
                                                <h4 class="m-0">$${computeTotalCOP(productos).toLocaleString()} COP</h4>
                                                <small>USD $${(computeTotalCOP(productos)/EXCHANGE_RATE_COP_TO_USD).toFixed(2)}</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pie de página -->
                                    <div class="text-center mt-4">
                                        <small class="text-muted">
                                            Gracias por tu compra. Para cualquier consulta, contáctanos en support@ysjifashion.com
                                        </small>
                                    </div>
                                </div>
                            `,
                            width: '700px',
                            confirmButtonText: facturaUrl ? 'Descargar PDF' : 'Ir al inicio',
                            showDenyButton: true,
                            denyButtonText: 'Ir al inicio',
                            customClass: {
                                container: 'factura-modal',
                                popup: 'border-0',
                                confirmButton: 'btn btn-primary px-4',
                                denyButton: 'btn btn-outline-secondary px-4'
                            }
                        }).then((result) => {
                            if (result.isConfirmed && facturaUrl) {
                                window.open(facturaUrl, '_blank');
                                window.location.href = "{% url 'index' %}";
                            } else {
                                window.location.href = "{% url 'index' %}";
                            }
                        });
                        clearStorageAfterPurchase();
                    } else {
                        console.warn('Verificación backend fallida', json);
                        Swal.fire({
                            icon: 'warning',
                            title: 'Pago realizado pero no verificado',
                            html: 'El pago se completó en PayPal pero el servidor no lo verificó.<br>Revisa logs del servidor.'
                        });
                    }
                    }).catch(err => {
                        console.error('Error enviando confirmación al backend', err);
                        Swal.fire('Error','Error de comunicación con el servidor tras el pago. Revisa consola.','error');
                    });

                }).catch(function(err){
                    console.error('[PayPal] capture error:', err);
                    Swal.fire('Error','No se pudo capturar la orden. Revisa consola.','error');
                    throw err;
                });
            },

            onCancel: function(data) {
                console.warn('[PayPal] onCancel', data);
                Swal.fire('Pago cancelado','Has cancelado el pago.','info');
            },

            onError: function(err) {
                console.error('[PayPal] onError', err);
                Swal.fire('Error','Ocurrió un error con PayPal. Revisa consola.','error');
            }

        }).render('#paypal-button-container');
    })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>