{% extends 'dashboard_base.html' %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card border-0 shadow">
        <div class="card-header bg-gold text-white">
          <h5 class="mb-0">{{ titulo }}</h5>
        </div>
        <div class="card-body">
          {% if form %}
          <form id="proveedorForm" method="post" novalidate>
            {% csrf_token %}
            <div class="mb-3">
              {{ form.nombre.label_tag }}
              {{ form.nombre }}
              <div class="invalid-feedback" id="error-nombre"></div>
            </div>

            <div class="mb-3">
              {{ form.correo.label_tag }}
              {{ form.correo }}
              <div class="invalid-feedback" id="error-correo"></div>
            </div>

            <div class="mb-3">
              {{ form.telefono.label_tag }}
              {{ form.telefono }}
              <div class="invalid-feedback" id="error-telefono"></div>
            </div>

            <div class="mb-3">
              {{ form.cedula.label_tag }}
              {{ form.cedula }}
              <div class="invalid-feedback" id="error-cedula"></div>
            </div>

            <div class="mb-3 form-check">
              {{ form.activo }}
              {{ form.activo.label_tag }}
            </div>

            <button type="submit" class="btn btn-primary">Guardar</button>
            <a href="{% url 'dashboard_proveedores' %}" class="btn btn-secondary">Cancelar</a>
          </form>
          {% elif proveedor %}
          <p>¬øEst√°s seguro que deseas eliminar el proveedor <strong>{{ proveedor.nombre }}</strong>?</p>
          <form id="eliminarForm" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Eliminar</button>
            <a href="{% url 'dashboard_proveedores' %}" class="btn btn-secondary">Cancelar</a>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.bg-gold {
  background-color: #000000 !important;
  color: white !important;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('proveedorForm');
  if (!form) return;

  const nombreInput = form.querySelector('input[name="nombre"]');
  const correoInput = form.querySelector('input[name="correo"]');
  const telefonoInput = form.querySelector('input[name="telefono"]');
  const cedulaInput = form.querySelector('input[name="cedula"]');

  const errorNombre = document.getElementById('error-nombre');
  const errorCorreo = document.getElementById('error-correo');
  const errorTelefono = document.getElementById('error-telefono');
  const errorCedula = document.getElementById('error-cedula');

  // Guardamos el correo original para no marcar error si es el mismo
  const correoOriginal = correoInput.value.trim().toLowerCase();

  // üîç Funci√≥n para verificar en el backend si el correo ya existe (tabla Proveedor)
  async function correoExiste(correo) {
    try {
      const response = await fetch(`/verificar-correo-proveedor/?correo=${encodeURIComponent(correo)}`);
      const data = await response.json();
      return data.existe;
    } catch (error) {
      console.error("Error verificando correo:", error);
      return false; // si falla la petici√≥n, no bloquear
    }
  }

  // ‚úÖ Validaci√≥n Nombre
  function validarNombre(nombre) {
    const regex = /^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]+(?: [A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]+)*$/;
    return regex.test(nombre.trim());
  }

  // ‚úÖ Validaci√≥n Correo con mensajes por error espec√≠fico + existencia
  async function validarCorreo(correo) {
    correo = correo.trim().toLowerCase();
    correoInput.value = correo;

    const partes = correo.split('@');
    const local = partes[0];

    if (!correo.includes('@')) {
      errorCorreo.textContent = 'Debe contener el s√≠mbolo "@".';
      return false;
    }

    if (local.length < 6) {
      errorCorreo.textContent = 'Debe tener al menos 6 caracteres antes del "@".';
      return false;
    }

    if (!/[a-z]/.test(local)) {
      errorCorreo.textContent = 'Debe incluir al menos una letra min√∫scula antes del "@".';
      return false;
    }

    if (/^\./.test(local) || /\.\./.test(local) || /\.$/.test(local)) {
      errorCorreo.textContent = 'El nombre de usuario no puede comenzar, terminar o tener dos puntos seguidos.';
      return false;
    }

    const regex = /^[a-z0-9.]{6,}@(gmail|hotmail|outlook|example)\.(com|net|org|edu)$/;
    if (!regex.test(correo)) {
      errorCorreo.textContent = 'Dominio inv√°lido. Solo se permite gmail, hotmail, outlook o example con extensiones .com, .net, .org o .edu.';
      return false;
    }

    // üö® Nueva verificaci√≥n en backend
    if (correo !== correoOriginal && await correoExiste(correo)) {
      errorCorreo.textContent = 'El correo ya est√° registrado.';
      return false;
    }

    errorCorreo.textContent = '';
    return true;
  }

  // ‚úÖ Tel√©fono: exactamente 10 d√≠gitos
  function validarTelefono(valor) {
    const regex = /^\d{10}$/;
    return regex.test(valor.trim());
  }

  // ‚úÖ C√©dula: de 7 a 10 d√≠gitos
  function validarCedula(valor) {
    const regex = /^\d{7,10}$/;
    return regex.test(valor.trim());
  }

  // ‚úÖ Funci√≥n gen√©rica de validaci√≥n
  function validarCampo(input, validarFn, errorElement, mensajeError) {
    if (!validarFn(input.value)) {
      input.classList.add('is-invalid');
      errorElement.textContent = mensajeError;
      return false;
    } else {
      input.classList.remove('is-invalid');
      errorElement.textContent = '';
      return true;
    }
  }

  // ‚úÖ Validaci√≥n en tiempo real
  nombreInput.addEventListener('input', () => {
    validarCampo(nombreInput, validarNombre, errorNombre, 'Solo se permiten letras y espacios simples.');
  });

  correoInput.addEventListener('input', async () => {
    const esValido = await validarCorreo(correoInput.value);
    correoInput.classList.toggle('is-invalid', !esValido);
  });

  telefonoInput.addEventListener('input', () => {
    validarCampo(telefonoInput, validarTelefono, errorTelefono, 'El tel√©fono debe tener exactamente 10 d√≠gitos.');
  });

  cedulaInput.addEventListener('input', () => {
    validarCampo(cedulaInput, validarCedula, errorCedula, 'La c√©dula debe tener entre 7 y 10 d√≠gitos.');
  });

  // ‚úÖ Validaci√≥n al enviar formulario
  form.addEventListener('submit', async e => {
    e.preventDefault();

    const validNombre = validarCampo(nombreInput, validarNombre, errorNombre, 'Solo se permiten letras y espacios simples.');
    const validCorreo = await validarCorreo(correoInput.value);
    const validTelefono = validarCampo(telefonoInput, validarTelefono, errorTelefono, 'El tel√©fono debe tener exactamente 10 d√≠gitos.');
    const validCedula = validarCampo(cedulaInput, validarCedula, errorCedula, 'La c√©dula debe tener entre 7 y 10 d√≠gitos.');

    if (validNombre && validCorreo && validTelefono && validCedula) {
      Swal.fire({
        icon: 'success',
        title: '¬°Formulario v√°lido!',
        text: 'Guardando proveedor...',
        confirmButtonText: 'Continuar'
      }).then(() => {
        form.submit();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Campos inv√°lidos',
        text: 'Por favor corrige los errores marcados en rojo.',
        confirmButtonText: 'Entendido'
      });
    }
  });

  // ‚úÖ Confirmaci√≥n eliminar
  const deleteForm = document.getElementById('eliminarForm');
  if (deleteForm) {
    deleteForm.addEventListener('submit', function (event) {
      event.preventDefault();
      Swal.fire({
        title: '¬øEst√°s seguro?',
        text: "Esta acci√≥n no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          deleteForm.submit();
        }
      });
    });
  }
});
</script>





{% endblock %}
